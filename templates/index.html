<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Welcome to SmartGuard!</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="page-container">
    <!-- Header -->
    <header class="page-header">
      <h1>Welcome to SmartGuard!</h1>
      <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
      
      <form class="language-selector-form" method="post" action="/set-language">
        <span class="globe-emoji">ğŸŒ</span>
        <select id="language-selector" name="language" onchange="this.form.submit();">
          <option value="en">English</option>
          <option value="es">EspaÃ±ol</option>
          <option value="fr">FranÃ§ais</option>
          <option value="de">Deutsch</option>
          <option value="ht">KreyÃ²l Ayisyen</option>
          <option value="zh">ä¸­æ–‡</option>
        </select>
      </form>
    </header>

    <!-- Main Content -->
    <div class="main-wrapper">
      <!-- Left: Chatbot Image -->
      <div class="chatbot-image-container">
        <img src="{{ url_for('static', filename='chatbot.png') }}" alt="Chatbot" class="robot-image">
      </div>

      <!-- Right: Chat Interface Card -->
      <div class="chat-card">
        <h2>Ask the Chatbot for Help!</h2>
        <div class="lesson-cards">
          <div class="card">
            <img src="{{ url_for('static', filename='math.png') }}" alt="Math Lesson">
            <h3>Math Lesson</h3>
            <p>Learn about fractions and decimals.</p>
          </div>
          <div class="card">
            <img src="{{ url_for('static', filename='science.png') }}" alt="Science Lesson">
            <h3>Science Lesson</h3>
            <p>Explore the solar system.</p>
          </div>
        </div>
        <div class="emoji-bar">
          <span>ğŸ˜Š</span><span>ğŸ˜²</span><span>ğŸ˜±</span>
        </div>

        <div id="chat-log" class="chat-log">
          <!-- Greeting appears here automatically -->
        </div>

        <form id="chat-form">
          <input type="text" id="user-input" placeholder="Type your question..." autocomplete="off" required>
          <button type="submit">Send</button>
          <button type="button" id="mic-button">ğŸ¤</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    const chatForm = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");
    const chatLog = document.getElementById("chat-log");
    const langSelector = document.getElementById("language-selector");
    const micButton = document.getElementById("mic-button");

    const greetings = {
      en: "Hello! I am your SmartGuard EDU here to help with your homework. Ask me about math, science, or history!",
      es: "Â¡Hola! Soy tu SmartGuard EDU para ayudarte con la tarea. Â¡PregÃºntame sobre matemÃ¡ticas, ciencia o historia!",
      fr: "Bonjour ! Je suis votre SmartGuard EDU pour vous aider avec vos devoirs. Demandez-moi des choses sur les maths, les sciences ou lâ€™histoire.",
      de: "Hallo! Ich bin dein SmartGuard EDU und helfe dir bei deinen Hausaufgaben. Frag mich nach Mathe, Wissenschaft oder Geschichte.",
      zh: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ SmartGuard EDUï¼Œå¯ä»¥å¸®åŠ©ä½ åšä½œä¸šã€‚å¯ä»¥é—®æˆ‘æ•°å­¦ã€ç§‘å­¦æˆ–å†å²æ–¹é¢çš„é—®é¢˜ã€‚"
    };

    function appendMessage(sender, text) {
      const div = document.createElement("div");
      div.className = "chat-message";
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function speak(text, lang) {
      if ('speechSynthesis' in window) {
        const ut = new SpeechSynthesisUtterance(text);
        ut.lang = lang + (lang === 'zh' ? '-CN' : '-US');
        speechSynthesis.speak(ut);
      }
    }

    function handleBotReply(text) {
      appendMessage("ğŸ¤– SmartGuard", text);
      speak(text, langSelector.value);
    }

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = userInput.value.trim();
      const lang = langSelector.value;
      if (!msg) return;
      appendMessage("ğŸ§‘â€ğŸ“ You", msg);
      userInput.value = "";
      try {
        const resp = await fetch("/chat-with-language", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({message: msg, language: lang})
        });
        const data = await resp.json();
        handleBotReply(data.reply || "Sorry, I didn't understand that.");
      } catch {
        handleBotReply("âš ï¸ There was a problem connecting to the chatbot.");
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const lang = langSelector.value;
      const greeting = greetings[lang] || greetings["en"];
      handleBotReply(greeting);
    });

    langSelector.addEventListener("change", () => {
      const g = greetings[langSelector.value] || greetings["en"];
      handleBotReply(g);
    });

    const recognizer = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognizer.interimResults = false;
    recognizer.maxAlternatives = 1;

    micButton.addEventListener("click", () => {
      recognizer.lang = langSelector.value + (langSelector.value === 'zh' ? '-CN' : '-US');
      recognizer.start();
      micButton.innerText = "ğŸ™ï¸ Listening...";
    });

    recognizer.onresult = e => {
      userInput.value = e.results[0][0].transcript;
      chatForm.dispatchEvent(new Event("submit"));
      micButton.innerText = "ğŸ¤";
    };

    recognizer.onerror = () => micButton.innerText = "ğŸ¤";
    recognizer.onend = () => micButton.innerText = "ğŸ¤";
  </script>
</body>
</html>
